name: push Enchant KPIs to Databox

on:
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes, UTC
  workflow_dispatch: {}      # allow manual runs from the UI

jobs:
  push:
    runs-on: ubuntu-latest

    # Make secrets available to all steps (optional but neat)
    env:
      ENCHANT_SITE:   ${{ secrets.ENCHANT_SITE }}
      ENCHANT_TOKEN:  ${{ secrets.ENCHANT_TOKEN }}
      DATABOX_TOKEN:  ${{ secrets.DATABOX_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: python -m pip install --upgrade pip requests

      - name: Databox smoke test
        run: |
          echo "Running Databox smoke test..."
          curl -u "${DATABOX_TOKEN}:" \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.databox.v2+json" \
            -d '[{"key":"__smoke_enchant_yir__","value":789}]' \
            https://push.databox.com/data

      - name: Push Enchant data
        run: python scripts/enchant_to_databox.py
